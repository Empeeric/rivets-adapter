// rivets.js
// version: 0.5.0
// author: Michael Richards
// license: MIT
(function(){var t,i,e,n,s,r=function(t,i){return function(){return t.apply(i,arguments)}},h=[].slice,o=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i;return-1};t={},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),t.Binding=function(){function t(t,i,e,n,s,h){var o,u,l,a;if(this.view=t,this.el=i,this.type=e,this.key=n,this.keypath=s,this.options=null!=h?h:{},this.update=r(this.update,this),this.unbind=r(this.unbind,this),this.bind=r(this.bind,this),this.publish=r(this.publish,this),this.sync=r(this.sync,this),this.set=r(this.set,this),this.formattedValue=r(this.formattedValue,this),!(this.binder=this.view.binders[e])){a=this.view.binders;for(o in a)l=a[o],"*"!==o&&-1!==o.indexOf("*")&&(u=RegExp("^"+o.replace("*",".+")+"$"),u.test(e)&&(this.binder=l,this.args=RegExp("^"+o.replace("*","(.+)")+"$").exec(e),this.args.shift()))}this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function&&(this.binder={routine:this.binder}),this.formatters=this.options.formatters||[],this.model=this.view.models[this.key]}return t.prototype.formattedValue=function(t){var i,e,n,s,r,o,u,l,a;for(o=this.formatters,s=0,r=o.length;r>s;s++)e=o[s],i=e.split(/\s+/),n=i.shift(),e=this.model[n]instanceof Function?this.model[n]:(null!=(u=this.options)?null!=(l=u.bindingOptions)?null!=(a=l.formatters)?a[n]:void 0:void 0:void 0)instanceof Function?this.options.bindingOptions.formatters[n]:this.view.formatters[n],(null!=e?e.read:void 0)instanceof Function?t=e.read.apply(e,[t].concat(h.call(i))):e instanceof Function&&(t=e.apply(null,[t].concat(h.call(i))));return t},t.prototype.set=function(t){var i;return t=t instanceof Function&&!this.binder["function"]?this.formattedValue(t.call(this.model)):this.formattedValue(t),null!=(i=this.binder.routine)?i.call(this,this.el,t):void 0},t.prototype.sync=function(){return this.set(this.options.bypass?this.model[this.keypath]:this.view.config.adapter.read(this.model,this.keypath))},t.prototype.publish=function(){var t,i,e,s,r,o,u,l,a;for(s=n(this.el),u=this.formatters.slice(0).reverse(),r=0,o=u.length;o>r;r++)i=u[r],t=i.split(/\s+/),e=t.shift(),(null!=(l=this.view.formatters[e])?l.publish:void 0)&&(s=(a=this.view.formatters[e]).publish.apply(a,[s].concat(h.call(t))));return this.view.config.adapter.publish(this.model,this.keypath,s)},t.prototype.bind=function(){var t,i,e,n,s,r,h,o,u;if(null!=(r=this.binder.bind)&&r.call(this,this.el),this.options.bypass?this.sync():(this.view.config.adapter.subscribe(this.model,this.keypath,this.sync),this.view.config.preloadData&&this.sync()),null!=(h=this.options.dependencies)?h.length:void 0){for(o=this.options.dependencies,u=[],n=0,s=o.length;s>n;n++)t=o[n],/^\./.test(t)?(e=this.model,i=t.substr(1)):(t=t.split("."),e=this.view.models[t.shift()],i=t.join(".")),u.push(this.view.config.adapter.subscribe(e,i,this.sync));return u}},t.prototype.unbind=function(){var t,i,e,n,s,r,h,o,u;if(null!=(r=this.binder.unbind)&&r.call(this,this.el),this.options.bypass||this.view.config.adapter.unsubscribe(this.model,this.keypath,this.sync),null!=(h=this.options.dependencies)?h.length:void 0){for(o=this.options.dependencies,u=[],n=0,s=o.length;s>n;n++)t=o[n],/^\./.test(t)?(e=this.model,i=t.substr(1)):(t=t.split("."),e=this.view.models[t.shift()],i=t.join(".")),u.push(this.view.config.adapter.unsubscribe(e,i,this.sync));return u}},t.prototype.update=function(){return this.unbind(),this.model=this.view.models[this.key],this.bind()},t}(),t.View=function(){function i(i,e,n){var s,h,o,u,l,a,d,c,f,p;for(this.els=i,this.models=e,this.options=null!=n?n:{},this.update=r(this.update,this),this.publish=r(this.publish,this),this.sync=r(this.sync,this),this.unbind=r(this.unbind,this),this.bind=r(this.bind,this),this.select=r(this.select,this),this.build=r(this.build,this),this.bindingRegExp=r(this.bindingRegExp,this),this.els.jquery||this.els instanceof Array||(this.els=[this.els]),d=["config","binders","formatters"],l=0,a=d.length;a>l;l++){if(h=d[l],this[h]={},this.options[h]){c=this.options[h];for(s in c)o=c[s],this[h][s]=o}f=t[h];for(s in f)o=f[s],null==(p=(u=this[h])[s])&&(u[s]=o)}this.build()}return i.prototype.bindingRegExp=function(){var t;return t=this.config.prefix,t?RegExp("^data-"+t+"-"):/^data-/},i.prototype.build=function(){var i,e,n,s,r,h,u,l,a,d,c,f=this;for(this.bindings=[],r=[],i=this.bindingRegExp(),s=function(e){var n,s,h,u,l,a,d,c,p,b,v,g,y,m,w,x,k,E,j,L,N,Q,R,V,O,B,F,T;if(0>o.call(r,e)){for(O=e.attributes,j=0,Q=O.length;Q>j;j++)if(n=O[j],i.test(n.name)){if(k=n.name.replace(i,""),!(h=f.binders[k])){B=f.binders;for(d in B)E=B[d],"*"!==d&&-1!==d.indexOf("*")&&(w=RegExp("^"+d.replace("*",".+")+"$"),w.test(k)&&(h=E))}if(h||(h=f.binders["*"]),h.block){for(F=e.getElementsByTagName("*"),L=0,R=F.length;R>L;L++)b=F[L],r.push(b);s=[n]}}for(T=s||e.attributes,N=0,V=T.length;V>N;N++)n=T[N],i.test(n.name)&&(v={},k=n.name.replace(i,""),m=function(){var t,i,e,s;for(e=n.value.split("|"),s=[],t=0,i=e.length;i>t;t++)y=e[t],s.push(y.trim());return s}(),u=function(){var t,i,e,n;for(e=m.shift().split("<"),n=[],t=0,i=e.length;i>t;t++)l=e[t],n.push(l.trim());return n}(),g=u.shift(),x=g.split(/\.|:/),v.formatters=m,v.bypass=-1!==g.indexOf(":"),x[0]?c=x.shift():(c=null,x.shift()),p=x.join("."),null!=f.models[c]&&((a=u.shift())&&(v.dependencies=a.split(/\s+/)),f.bindings.push(new t.Binding(f,e,k,c,p,v))));s&&(s=null)}},d=this.els,h=0,l=d.length;l>h;h++)for(e=d[h],s(e),c=e.getElementsByTagName("*"),u=0,a=c.length;a>u;u++)n=c[u],null!=n.attributes&&s(n)},i.prototype.select=function(t){var i,e,n,s,r;for(s=this.bindings,r=[],e=0,n=s.length;n>e;e++)i=s[e],t(i)&&r.push(i);return r},i.prototype.bind=function(){var t,i,e,n,s;for(n=this.bindings,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.bind());return s},i.prototype.unbind=function(){var t,i,e,n,s;for(n=this.bindings,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.unbind());return s},i.prototype.sync=function(){var t,i,e,n,s;for(n=this.bindings,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.sync());return s},i.prototype.publish=function(){var t,i,e,n,s;for(n=this.select(function(t){return t.binder.publishes}),s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.publish());return s},i.prototype.update=function(t){var i,e,n,s;null==t&&(t={}),s=[];for(e in t)n=t[e],this.models[e]=n,s.push(function(){var t,n,s,r;for(s=this.select(function(t){return t.key===e}),r=[],t=0,n=s.length;n>t;t++)i=s[t],r.push(i.update());return r}.call(this));return s},i}(),i=function(t,i,e,n){var s;return s=function(t){return e.call(n,t)},null!=window.jQuery?(t=jQuery(t),null!=t.on?t.on(i,s):t.bind(i,s)):null!=window.addEventListener?t.addEventListener(i,s,!1):(i="on"+i,t.attachEvent(i,s)),s},s=function(t,i,e){return null!=window.jQuery?(t=jQuery(t),null!=t.off?t.off(i,e):t.unbind(i,e)):window.removeEventListener?t.removeEventListener(i,e,!1):(i="on"+i,t.detachEvent(i,e))},n=function(t){var i,e,n,s;if(null!=window.jQuery)switch(t=jQuery(t),t[0].type){case"checkbox":return t.is(":checked");default:return t.val()}else switch(t.type){case"checkbox":return t.checked;case"select-multiple":for(s=[],e=0,n=t.length;n>e;e++)i=t[e],i.selected&&s.push(i.value);return s;default:return t.value}},t.binders={enabled:function(t,i){return t.disabled=!i},disabled:function(t,i){return t.disabled=!!i},checked:{publishes:!0,bind:function(t){return this.currentListener=i(t,"change",this.publish)},unbind:function(t){return s(t,"change",this.currentListener)},routine:function(t,i){var e;return t.checked="radio"===t.type?(null!=(e=t.value)?""+e:void 0)===(null!=i?""+i:void 0):!!i}},unchecked:{publishes:!0,bind:function(t){return this.currentListener=i(t,"change",this.publish)},unbind:function(t){return s(t,"change",this.currentListener)},routine:function(t,i){var e;return t.checked="radio"===t.type?(null!=(e=t.value)?""+e:void 0)!==(null!=i?""+i:void 0):!i}},show:function(t,i){return t.style.display=i?"":"none"},hide:function(t,i){return t.style.display=i?"none":""},html:function(t,i){return t.innerHTML=null!=i?i:""},value:{publishes:!0,bind:function(t){return this.currentListener=i(t,"change",this.publish)},unbind:function(t){return s(t,"change",this.currentListener)},routine:function(t,i){var e,n,s,r,h,u,l;if(null!=window.jQuery){if(t=jQuery(t),(null!=i?""+i:void 0)!==(null!=(r=t.val())?""+r:void 0))return t.val(null!=i?i:"")}else if("select-multiple"===t.type){if(null!=i){for(l=[],n=0,s=t.length;s>n;n++)e=t[n],l.push(e.selected=(h=e.value,o.call(i,h)>=0));return l}}else if((null!=i?""+i:void 0)!==(null!=(u=t.value)?""+u:void 0))return t.value=null!=i?i:""}},text:function(t,i){return null!=t.innerText?t.innerText=null!=i?i:"":t.textContent=null!=i?i:""},"on-*":{"function":!0,routine:function(t,e){return this.currentListener&&s(t,this.args[0],this.currentListener),this.currentListener=i(t,this.args[0],e,this.model)}},"each-*":{block:!0,bind:function(t){return t.removeAttribute(["data",this.view.config.prefix,this.type].join("-").replace("--","-"))},unbind:function(){var t,i,e,n,s;if(null!=this.iterated){for(n=this.iterated,s=[],i=0,e=n.length;e>i;i++)t=n[i],s.push(t.unbind());return s}},routine:function(i,e){var n,s,r,h,o,u,l,a,d,c,f,p,b,v,g,y,m,w,x;if(null!=this.iterated)for(g=this.iterated,d=0,p=g.length;p>d;d++)for(a=g[d],a.unbind(),y=a.els,c=0,b=y.length;b>c;c++)s=y[c],s.parentNode.removeChild(s);else this.marker=document.createComment(" rivets: "+this.type+" "),i.parentNode.insertBefore(this.marker,i),i.parentNode.removeChild(i);if(this.iterated=[],e){for(x=[],f=0,v=e.length;v>f;f++){r=e[f],n={},m=this.view.models;for(u in m)o=m[u],n[u]=o;n[this.args[0]]=r,h=i.cloneNode(!0),l=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,this.marker.parentNode.insertBefore(h,null!=(w=l.nextSibling)?w:null),a=new t.View(h,n,this.view.options),a.bind(),x.push(this.iterated.push(a))}return x}}},"class-*":function(t,i){var e;return e=" "+t.className+" ",!i==(-1!==e.indexOf(" "+this.args[0]+" "))?t.className=i?""+t.className+" "+this.args[0]:e.replace(" "+this.args[0]+" "," ").trim():void 0},"*":function(t,i){return i?t.setAttribute(this.type,i):t.removeAttribute(this.type)}},t.config={preloadData:!0},t.formatters={},e=function(i){return i.binders=t.binders,i.formatters=t.formatters,i.config=t.config,i.configure=function(i){var e,n;null==i&&(i={});for(e in i)n=i[e],t.config[e]=n},i.bind=function(i,e,n){var s;return null==e&&(e={}),null==n&&(n={}),s=new t.View(i,e,n),s.bind(),s}},"object"==typeof exports?e(exports):"function"==typeof define&&define.amd?define(["exports"],function(t){return e(this.rivets=t),t}):e(this.rivets={})}).call(this);